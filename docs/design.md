# テトリス ゲーム設計書

## 要件定義書

### 目的
- ブラウザ上で動作するテトリスゲームの実装
- キーボード操作による快適なゲームプレイの提供

### 機能要件
1. ゲームプレイ

### 非機能要件
1. パフォーマンス
   - 画面描画は60FPSを維持
   - キー入力からの応答は100ms以内
   - メモリ使用量は50MB以下を維持

2. 信頼性
   - ブラウザのリロード時にゲーム状態を保持
   - 予期せぬエラー発生時は安全に初期状態に復帰

3. 互換性
   - モダンブラウザ（Chrome、Firefox、Safari、Edge最新版）での動作保証
   - スマートフォン・タブレットでの表示対応（将来的な機能として）

4. メンテナンス性
   - コードの疎結合性を確保
   - 単一責任の原則に従ったモジュール設計
   - 詳細なコメントとドキュメンテーション
   - ESLintによるコード品質の維持

### 機能要件
1. ゲームプレイ
   - 7種類のテトリミノの表示と操作
   - 次のブロックのプレビュー表示
   - ブロックの回転と移動
   - ラインの消去とスコア加算
   - ゲームオーバー判定

2. 操作方法
   - 左右矢印キー: ブロックの左右移動
   - 上矢印キー: ブロックの回転
   - 下矢印キー: 落下速度上昇
   - スペースキー: 即時落下

3. 表示要素
   - メインゲーム画面
   - 次のブロックプレビュー
   - 現在のスコア
   - 操作方法の説明

## 設計書

### 画面設計

#### レイアウト構成
```
+------------------------+
|  [ゲーム画面] [情報欄] |
|           |   [Next]  |
|           |  [Score]  |
|           | [操作説明] |
+------------------------+
```

#### 画面要素
1. ゲーム画面
   - サイズ: 300x600px
   - 背景色: 黒
   - グリッド: 10x20

2. 情報欄
   - 次のブロック表示: 120x120px
   - スコア表示
   - 操作方法説明

### 機能設計

#### クラス/モジュール構成

1. ゲームループ管理
   - ゲームの状態更新
   - 画面の描画更新
   - フレームレート制御

2. テトリミノ管理
   - 形状定義
   - 色定義
   - 回転ロジック
   - 衝突判定

3. スコア管理
   - ライン消去判定
   - スコア計算
   - スコア表示更新

4. 入力処理
   - キーボードイベント処理
   - 移動・回転制御
   - 落下速度制御

#### データ構造

1. ゲームフィールド
   - 10x20の2次元配列
   - 各セルは数値で状態管理（0: 空、1-7: ブロックの種類）

2. テトリミノ
   - 形状: 4x4の2次元配列
   - 位置: x, y座標
   - 色: カラーコード

#### アルゴリズム

1. 衝突判定
   - 移動時の壁との衝突チェック
   - 回転時の衝突チェック
   - 他のブロックとの衝突チェック

2. ライン消去
   - 完成ラインの検出
   - ライン消去とブロックの落下
   - スコア加算

3. 回転処理
   - テトリミノの回転行列計算
   - 回転後の衝突判定
   - 壁蹴り処理

#### エラーハンドリング

1. 予期せぬエラー
   - window.onerrorでグローバルエラーをキャッチ
   - エラー発生時はゲーム状態を初期化
   - ユーザーに適切なエラーメッセージを表示

2. 状態異常の検出と回復
   - ゲーム状態の整合性チェック
   - 異常検出時の自動リカバリー
   - デバッグ情報のコンソール出力

#### テスト戦略

1. 単体テスト
   - Jest/Mochaを使用したテストの自動化
   - 各モジュールの機能を個別にテスト
   - エッジケースの網羅的なテスト

2. 統合テスト
   - モジュール間の連携テスト
   - ゲームの一連の流れのテスト
   - パフォーマンステスト（FPS、レスポンス時間）

3. ブラウザ互換性テスト
   - 各種ブラウザでの動作確認
   - レスポンシブデザインのテスト
   - 入力デバイスの互換性テスト

4. 負荷テスト
   - 長時間プレイ時の安定性確認
   - メモリリークのチェック
   - CPU使用率の監視
